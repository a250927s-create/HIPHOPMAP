<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>HIPHOP HISTORY MAP</title>

  <link
    href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />

  <style>
    body {
      margin: 0;
      background: #000;
      font-family: 'Impact', sans-serif;
      overflow: hidden;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    /* ã‚¿ãƒ¼ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ« */
    #turntable {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: radial-gradient(#222 40%, #000 70%);
      border: 4px solid #ffcc00;
      cursor: grab;
    }

    #record {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: 
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.02), transparent 10%),
        repeating-radial-gradient(circle, #111, #111 4px, #000 8px);
      position: relative;
      transition: transform 0.08s linear;
    }
    /* ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸­å¤®ã®èµ¤ã„ãƒ©ãƒ™ãƒ«ã¨æ–‡å­— */
    #record::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ff6666, #cc0000 70%);
      box-shadow: 0 0 16px rgba(204,0,0,0.6) inset, 0 4px 12px rgba(0,0,0,0.6);
      border: 2px solid rgba(255,255,255,0.06);
      pointer-events: none;
    }
    #record::after {
      content: 'HIPHOP';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      font-weight: 900;
      color: #fff;
      letter-spacing: 1.5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      pointer-events: none;
    }
    #turntable.grabbing { cursor: grabbing; }

    #year {
      position: absolute;
      bottom: 210px;
      right: 20px;
      color: #ffcc00;
      font-size: 24px;
      text-shadow: 0 0 10px #ff0;
    }
    /* ãƒãƒ¼ã‚«ãƒ¼ï¼ˆãƒã‚¤ã‚¯ï¼‰ */
    .marker {
      font-size: 24px;
      line-height: 24px;
      transform: translate(-50%, -50%);
      text-shadow: 0 0 6px #000;
    }
    /* HIPHOPé¢¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .maplibregl-popup.hiphop-popup .maplibregl-popup-content {
      background: linear-gradient(180deg, #111 0%, #1a1a1a 100%);
      color: #ffcc00;
      border: 3px solid #ffcc00;
      border-radius: 8px;
      padding: 10px 12px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      box-shadow: 0 6px 18px rgba(0,0,0,0.8), 0 0 12px rgba(255,204,0,0.08) inset;
      max-width: 220px;
    }
    .hiphop-popup .hiphop-title {
      font-size: 16px;
      color: #ffffff;
      background: linear-gradient(90deg,#ffcc00,#ff9900);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 4px rgba(0,0,0,0.6);
      margin-bottom: 6px;
      font-weight: 800;
    }
    .hiphop-popup .hiphop-body div {
      font-size: 12px;
      color: #ffd; /* pale yellow */
      margin: 2px 0;
    }
    .hiphop-popup .hiphop-key { color: #ffcc66; font-weight:700; margin-right:6px; }
  .hiphop-avatar { width:40px; height:40px; border-radius:50%; margin-right:6px; vertical-align:middle; border:2px solid #222; box-shadow:0 2px 6px rgba(0,0,0,0.6); }
  .hiphop-person { display:inline-flex; align-items:center; gap:8px; margin:4px 0; }
  .hiphop-person-name { font-size:12px; color:#ffd; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="year">1970</div>
  <div id="turntable">
    <div id="record"></div>
  </div>

  <audio id="scratch" src="scratch.mp3"></audio>
  <audio id="hiphop" src="hiphop.mp3"></audio>

  <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
  <script src="data.js"></script>

  <script>
    // data.js ãŒé…åˆ—ãƒªãƒ†ãƒ©ãƒ«ã ã‘ã«ãªã£ã¦ã„ã‚‹ï¼ˆhistoryData ã‚’å®šç¾©ã—ãªã„ï¼‰å ´åˆã«å¯¾å¿œã™ã‚‹ãŸã‚ã€
    // maplibre ã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¡ã€å¿…è¦ãªã‚‰ data.js ã‚’ fetch ã—ã¦ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‹ã‚‰åˆæœŸåŒ–ã—ã¾ã™ã€‚
    function ensureHistoryData() {
      if (window.historyData) return Promise.resolve();
      return fetch('data.js').then(resp => {
        if (!resp.ok) throw new Error('Failed to fetch data.js: ' + resp.status);
        return resp.text();
      }).then(text => {
        // æœŸå¾…ã•ã‚Œã‚‹å½¢å¼ã¯ JSON é…åˆ—ãƒªãƒ†ãƒ©ãƒ«ãªã®ã§ã¾ãš JSON.parse ã‚’è©¦ã™
        try {
          window.historyData = JSON.parse(text);
          return;
        } catch (err) {
          // ãã‚Œã§ã‚‚ã ã‚ãªã‚‰ JS ã¨ã—ã¦è©•ä¾¡ã™ã‚‹ï¼ˆ'[' ... ']' ã®é…åˆ—ãƒªãƒ†ãƒ©ãƒ«ã§ã‚ã‚Œã°å®‰å…¨ã«è©•ä¾¡ã§ãã‚‹ï¼‰
          try {
            window.historyData = (0, eval)('(' + text + ')');
            return;
          } catch (err2) {
            throw new Error('Unable to parse data.js');
          }
        }
      });
    }

    function waitForLibsAndData() {
      if (!window.maplibregl) { setTimeout(waitForLibsAndData, 100); return; }
      ensureHistoryData().then(() => {
        initApp();
      }).catch(err => {
        console.error('Failed to load historyData:', err);
        // å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
        setTimeout(waitForLibsAndData, 500);
      });
    }

    function initApp() {
      const map = new maplibregl.Map({
        container: 'map',
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å…¬é–‹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼ˆMapLibre ã®ãƒ‡ãƒ¢ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
        style: 'https://demotiles.maplibre.org/style.json',
        center: [0, 20],
        zoom: 1.5
      });

      let currentYear = 1970;
      let index = 0; // æ¬¡ã«è¿½åŠ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      let coordinates = [];
      let markers = []; // è¿½åŠ ã—ãŸãƒãƒ¼ã‚«ãƒ¼ã®å‚ç…§ã‚’ä¿æŒ
      let personInfoMap = {}; // name -> { image: url, page: url }
      // åå‰ãƒãƒƒãƒ”ãƒ³ã‚°: è¡¨ç¤ºåï¼ˆæ—¥æœ¬èªãªã©ï¼‰ -> Wikipedia ã®ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè‹±èªç­‰ï¼‰
      const nameMapping = {
        'ã‚°ãƒ©ãƒ³ãƒ‰ãƒ»ãƒã‚¹ã‚¿ãƒ¼ãƒ»ãƒ•ãƒ©ãƒƒã‚·ãƒ¥': 'Grandmaster_Flash',
        // è¿½åŠ ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ã“ã“ã«æ›¸ã„ã¦ãã ã•ã„
      };

      const record = document.getElementById('record');
      const yearLabel = document.getElementById('year');
      const scratch = document.getElementById('scratch');
      const hiphop = document.getElementById('hiphop');

      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆSVG data URIï¼‰
      const placeholderAvatar = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#222"/><text x="50%" y="50%" font-family="Impact,Arial,Helvetica" font-size="18" fill="#ffcc00" dominant-baseline="middle" text-anchor="middle">?</text></svg>');

      // å„ person åã«ã¤ã„ã¦ Wikipedia REST API ã‹ã‚‰ã‚µãƒ ãƒã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ fetchï¼‰
      // æˆåŠŸã—ãŸã‚‰ personImageMap[name] = urlã€‚
      function fetchPersonImages() {
        const names = new Set();
        historyData.forEach(item => {
          if (Array.isArray(item.people)) item.people.forEach(p => names.add(p));
        });

        const promises = Array.from(names).map(name => {
          // ãƒãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã£ã¦æ¤œç´¢ã™ã‚‹ï¼ˆæ—¥æœ¬èªå -> è‹±èªãƒšãƒ¼ã‚¸ï¼‰
          const lookup = nameMapping[name] || name;
          const encoded = encodeURIComponent(lookup);
          const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encoded}`;
          return fetch(url)
            .then(resp => {
              if (!resp.ok) throw new Error('no page');
              return resp.json();
            })
            .then(json => {
              const image = (json.thumbnail && json.thumbnail.source) ? json.thumbnail.source : placeholderAvatar;
              const page = (json.content_urls && json.content_urls.desktop && json.content_urls.desktop.page)
                ? json.content_urls.desktop.page
                : `https://en.wikipedia.org/wiki/${encodeURIComponent(lookup)}`;
              personInfoMap[name] = { image, page };
            })
            .catch(() => {
              const lookup = nameMapping[name] || name;
              personInfoMap[name] = { image: placeholderAvatar, page: `https://en.wikipedia.org/wiki/${encodeURIComponent(lookup)}` };
            });
        });

        return Promise.all(promises);
      }

      // --- å¹´ãƒ™ãƒ¼ã‚¹ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’ç®¡ç†ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
      const MIN_YEAR = 1970;

      // æŒ‡å®šã® item ã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆã—ã¦è¿”ã™
      function createMarkerForItem(item) {
        const el = document.createElement('div');
        el.className = 'marker';
        el.innerText = 'ğŸ¤';
        el.style.color = '#ffcc00';
        el.style.cursor = 'pointer';

        const entries = Object.entries(item).filter(([k]) => k !== 'lng' && k !== 'lat');
        const titleKey = entries.find(([k]) => /title|name|artist/i.test(k));
        const title = titleKey ? titleKey[1] : `Year ${item.year}`;
        const bodyParts = [];
        let songFound = false;
        entries.filter(([k]) => !/title|name|artist/i.test(k)).forEach(([k, v]) => {
          if (k === 'people' && Array.isArray(v)) {
            const imgs = v.map(name => {
              const info = personInfoMap[name] || { image: placeholderAvatar, page: `https://en.wikipedia.org/wiki/${encodeURIComponent(name)}` };
              const src = info.image;
              const page = info.page;
              return `<a class="hiphop-person" href="${page}" target="_blank" rel="noopener noreferrer"><img class="hiphop-avatar" src="${src}" alt="${name}" title="${name}"><span class="hiphop-person-name">${name}</span></a>`;
            }).join('');
            bodyParts.push(`${imgs}`);
          } else if (k === 'song') {
            songFound = true;
            const url = item.song_url ? item.song_url : '';
            if (url) {
              bodyParts.push(`<div><span class="hiphop-key">song</span><span class="hiphop-val">${v} <a href="${url}" target="_blank" rel="noopener noreferrer">ğŸ”—</a></span></div>`);
            } else {
              bodyParts.push(`<div><span class="hiphop-key">song</span><span class="hiphop-val">${v}</span></div>`);
            }
          } else if (k === 'song_url') {
            // skip
          } else {
            bodyParts.push(`<div><span class="hiphop-key">${k}</span><span class="hiphop-val">${v}</span></div>`);
          }
        });
        if (!songFound && item.song_url) {
          bodyParts.push(`<div><span class="hiphop-key">song</span><a class="hiphop-val" href="${item.song_url}" target="_blank" rel="noopener noreferrer">ğŸ”— Listen</a></div>`);
        }
        const bodyHtml = bodyParts.join('');
        const popupHtml = `<div class="hiphop-popup"><div class="hiphop-title">${title}</div><div class="hiphop-body">${bodyHtml}</div></div>`;

        const marker = new maplibregl.Marker(el).setLngLat([item.lng, item.lat]).addTo(map);
        const popup = new maplibregl.Popup({ offset: 25, className: 'hiphop-popup' }).setHTML(popupHtml);
        marker.setPopup(popup);

        // ã‚¯ãƒªãƒƒã‚¯ã§ä¸­å¤®ãƒ¬ã‚³ãƒ¼ãƒ‰ç”»åƒã«åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
        el.addEventListener('click', () => {
          // if record-center-img exists from other edits, try to update it; otherwise ignore
          const img = document.getElementById('record-center-img');
          const rec = document.getElementById('record');
          const cover = item.image || item.cover || (item.people && item.people.length && personInfoMap[item.people[0]] && personInfoMap[item.people[0]].image);
          if (img && cover) {
            img.src = cover;
            img.style.opacity = '1';
            rec && rec.classList && rec.classList.add('has-cover');
          }
        });

        return marker;
      }

      // æŒ‡å®šå¹´ã¾ã§ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒãƒƒãƒ—ã«è¡¨ç¤ºã™ã‚‹ï¼ˆãã‚Œä»¥é™ã®ã‚‚ã®ã¯å‰Šé™¤ï¼‰
      function renderMarkersForYear(year) {
        // clamp year
        if (typeof year !== 'number') return;
        if (year < MIN_YEAR) year = MIN_YEAR;
        yearLabel.innerText = year;

        // remove existing markers
        markers.forEach(m => { try { m.remove(); } catch (e) {} });
        markers = [];

        // add markers for all items with item.year <= year
        (window.historyData || []).forEach(item => {
          if (typeof item.year === 'number' && item.year <= year) {
            if (typeof item.lng === 'number' && typeof item.lat === 'number') {
              const m = createMarkerForItem(item);
              markers.push(m);
            }
          }
        });
      }

      // ãƒãƒƒãƒ—èª­ã¿è¾¼ã¿æ™‚ã«äººç‰©ç”»åƒã‚’ãƒ•ã‚§ãƒƒãƒã—ã¦åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      map.on('load', () => {
        fetchPersonImages().then(() => {
          console.log('person images loaded');
          renderMarkersForYear(currentYear);
        }).catch(() => {
          console.warn('person image fetch failed');
          renderMarkersForYear(currentYear);
        });
      });

      // ãƒã‚¤ãƒ³ã‚¿ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼‰ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å›ã—ã¦å¹´ã‚’é€²ã‚ã‚‹
      // 45deg ã”ã¨ã«æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹
      const turntable = document.getElementById('turntable');
      let isPointerDown = false;
      let lastAngle = 0;
      let accumulated = 0; // ç´¯ç©å›è»¢é‡(deg)
      let totalRotation = 0; // è¦‹ãŸç›®ã®å›è»¢è§’
      const STEP_DEG = 45; // 1ã‚¹ãƒ†ãƒƒãƒ—ã‚ãŸã‚Šã®è§’åº¦

      function getAngleFromEvent(e) {
        const rect = turntable.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        const x = e.clientX;
        const y = e.clientY;
        const rad = Math.atan2(y - cy, x - cx);
        return rad * (180 / Math.PI);
      }

      function normalizeDelta(delta) {
        // Normalize to [-180, 180]
        while (delta > 180) delta -= 360;
        while (delta < -180) delta += 360;
        return delta;
      }

      function addNextEntry() {
        if (index >= historyData.length) return;

        // ã‚¹ã‚¯ãƒ©ãƒƒãƒéŸ³ï¼ˆé ­å‡ºã—ï¼‰
        try { scratch.currentTime = 0; } catch (err) {}
        scratch.play();

        const item = historyData[index];
        currentYear = item.year;
        yearLabel.innerText = currentYear;

        // ãƒãƒ¼ã‚«ãƒ¼ï¼ˆãƒã‚¤ã‚¯ï¼‰ã‚’ä½œæˆã—ã¦è¿½åŠ ï¼ˆæ—¢å­˜ã®ã‚‚ã®ã¯æ¶ˆã•ãªã„ï¼‰
        const el = document.createElement('div');
        el.className = 'marker';
        el.innerText = 'ğŸ¤';
        el.style.color = '#ffcc00';

        const marker = new maplibregl.Marker(el)
          .setLngLat([item.lng, item.lat])
          .addTo(map);
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
        el.style.cursor = 'pointer';
        // popup ç”¨ã® HTML ã‚’ç”Ÿæˆï¼ˆlng/lat ã¯é™¤å¤–ï¼‰
        // popup ç”¨ã® HTML ã‚’ç”Ÿæˆï¼ˆlng/lat ã¯é™¤å¤–ï¼‰
        const entries = Object.entries(item).filter(([k]) => k !== 'lng' && k !== 'lat');
        const titleKey = entries.find(([k]) => /title|name|artist/i.test(k));
        const title = titleKey ? titleKey[1] : `Year ${item.year}`;
        const bodyParts = [];
        // song ã¨ song_url ãŒä¸¡æ–¹ã‚ã‚‹ã¨é‡è¤‡ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€
        // ã“ã“ã§ã¯ song_url ã‚’ç›´æ¥å‡ºã•ãšã€song ãŒã‚ã‚‹å ´åˆã¯ song ã«ãƒªãƒ³ã‚¯ã‚’ä»˜ã‘ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
        let songFound = false;
        entries.filter(([k]) => !/title|name|artist/i.test(k)).forEach(([k, v]) => {
            if (k === 'people' && Array.isArray(v)) {
              const imgs = v.map(name => {
              const info = personInfoMap[name] || { image: placeholderAvatar, page: `https://en.wikipedia.org/wiki/${encodeURIComponent(name)}` };
              const src = info.image;
              const page = info.page;
              return `<a class="hiphop-person" href="${page}" target="_blank" rel="noopener noreferrer"><img class="hiphop-avatar" src="${src}" alt="${name}" title="${name}"><span class="hiphop-person-name">${name}</span></a>`;
            }).join('');
            bodyParts.push(`${imgs}`);
          } else if (k === 'song') {
            songFound = true;
            const url = item.song_url ? item.song_url : '';
            if (url) {
              bodyParts.push(`<div><span class="hiphop-key">song</span><span class="hiphop-val">${v} <a href="${url}" target="_blank" rel="noopener noreferrer">ğŸ”—</a></span></div>`);
            } else {
              bodyParts.push(`<div><span class="hiphop-key">song</span><span class="hiphop-val">${v}</span></div>`);
            }
          } else if (k === 'song_url') {
            // song ãŒæ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°é‡è¤‡ã‚’é¿ã‘ã‚‹ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
            // song ãŒç„¡ã‘ã‚Œã°ä¸‹ã§ã¾ã¨ã‚ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã“ã“ã§ã¯ã‚¹ã‚­ãƒƒãƒ—
          } else {
            bodyParts.push(`<div><span class="hiphop-key">${k}</span><span class="hiphop-val">${v}</span></div>`);
          }
        });
        // song ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç„¡ãã€song_url ãŒã‚ã‚‹å ´åˆã¯ Listen ãƒªãƒ³ã‚¯ã ã‘è¡¨ç¤ºã™ã‚‹
        if (!songFound && item.song_url) {
          bodyParts.push(`<div><span class="hiphop-key">song</span><a class="hiphop-val" href="${item.song_url}" target="_blank" rel="noopener noreferrer">ğŸ”— Listen</a></div>`);
        }
        const bodyHtml = bodyParts.join('');
        const popupHtml = `<div class="hiphop-popup"><div class="hiphop-title">${title}</div><div class="hiphop-body">${bodyHtml}</div></div>`;
        const popup = new maplibregl.Popup({ offset: 25, className: 'hiphop-popup' }).setHTML(popupHtml);
        marker.setPopup(popup);
        markers.push(marker);

        // åº§æ¨™ã‚’è“„ç©ï¼ˆãƒ«ãƒ¼ãƒˆæç”»ã¯ç„¡åŠ¹åŒ–ï¼‰
        coordinates.push([item.lng, item.lat]);
        // Route drawing removed: no source update performed.

        // hiphop æ›²ã‚’æµã™ï¼ˆæ¯å›é ­å‡ºã—ã§å†ç”Ÿï¼‰
        try { hiphop.currentTime = 0; } catch (err) {}
        hiphop.play();

        index++;
      }

      function addPreviousEntry() {
        // 1ã¤æˆ»ã‚‹ï¼ˆç›´å‰ã«è¿½åŠ ã—ãŸã‚‚ã®ã‚’å‰Šé™¤ï¼‰
        if (index <= 0) return;

        // ã‚¹ã‚¯ãƒ©ãƒƒãƒéŸ³ï¼ˆé ­å‡ºã—ï¼‰
        try { scratch.currentTime = 0; } catch (err) {}
        scratch.play();

        // ãƒãƒ¼ã‚«ãƒ¼ã¨åº§æ¨™ã‚’å–ã‚Šé™¤ã
        index--; // index ã¯æ¬¡ã«è¿½åŠ ã™ã‚‹ä½ç½®ãªã®ã§å…ˆã«æ¸›ã‚‰ã™
        const marker = markers.pop();
        if (marker) marker.remove();

        coordinates.pop();
        // Route drawing removed: no source update performed.

        // å¹´è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆæ®‹ã‚ŠãŒãªã‘ã‚Œã°åˆæœŸ1970ã«æˆ»ã™ï¼‰
        if (index > 0) {
          currentYear = historyData[index - 1].year;
        } else {
          currentYear = 1970;
        }
        yearLabel.innerText = currentYear;

        // hiphop ã¯å¾Œé€€æ™‚ã¯åœæ­¢ã™ã‚‹
        try { hiphop.pause(); } catch (err) {}
      }

      turntable.addEventListener('pointerdown', (e) => {
        isPointerDown = true;
        turntable.setPointerCapture(e.pointerId);
        turntable.classList.add('grabbing');
        lastAngle = getAngleFromEvent(e);
      });

      window.addEventListener('pointermove', (e) => {
        if (!isPointerDown) return;
        const angle = getAngleFromEvent(e);
        let delta = angle - lastAngle;
        delta = normalizeDelta(delta);
        lastAngle = angle;

        // ç´¯ç©å›è»¢ã§å‰å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆ¤å®š
        accumulated += delta;
        totalRotation += delta;
        record.style.transform = `rotate(${totalRotation}deg)`;

        // å‰ã«é€²ã‚€ï¼ˆæ™‚è¨ˆå›ã‚Šï¼‰
        while (accumulated >= STEP_DEG) {
          accumulated -= STEP_DEG;
          addNextEntry();
        }

        // æˆ»ã‚‹ï¼ˆåæ™‚è¨ˆå›ã‚Šï¼‰
        while (accumulated <= -STEP_DEG) {
          accumulated += STEP_DEG;
          addPreviousEntry();
        }
      });

      window.addEventListener('pointerup', (e) => {
        if (!isPointerDown) return;
        isPointerDown = false;
        try { turntable.releasePointerCapture(e.pointerId); } catch (err) {}
        turntable.classList.remove('grabbing');
      });
    }

    waitForLibsAndData();
  </script>
</body>
</html>
